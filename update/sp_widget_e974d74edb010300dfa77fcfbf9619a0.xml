<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function($scope,spUtil,$timeout,$rootScope,$http,$uibModal) {
	/* widget controller */
	var c = this;
	$scope.snippet = {};
	$scope.simpleTags = '';	
	$scope.snippetType = {};
	$scope.snippetApp = {};
	console.log("FIRST",$scope.snippet);
	console.log("FIRST",c.data.snippet);
	
	var editor = ace.edit("editor");
    editor.setTheme("ace/theme/sqlserver");
    editor.getSession().setMode("ace/mode/javascript");
		editor.getSession().setUseWrapMode(true);
		
		editor.setOptions({
			minLines: 10,
			maxLines: 20
		});
	
	if (c.data.snippet) {
		$scope.snippet = c.data.snippet;
		console.log("Is There a SNippet",c.data.snippet.editor,c.data.snippet.snippet);
		if (c.data.snippet.editor || c.data.snippet.snippet) {
			editor.setValue(c.data.snippet.editor);
			editor.clearSelection();
		} else {
			editor.setValue("//Enter your code here");
		}
	
		$scope.snippetType = {
			displayValue: c.data.snippet.type.display_value,
			value: c.data.snippet.type.value,
			name: 'snippetType'
		};
		$scope.snippetApp = {
			displayValue: c.data.snippet.application.display_value,
			value: c.data.snippet.application.value,
			name: 'snippetApp'
		};
	}
	
	
	$scope.openModal = function(tpl) {
		$rootScope.modalInstance = $uibModal.open({
			templateUrl: tpl,
			scope: $scope
		});
	}
	
	$scope.closeModal = function() {
		console.log("triggered");
		$rootScope.modalInstance.close();
	}
	
	
	
	/*c.openModal = function(tpl) {
		c.modalInstance = $uibModal.open({
			templateUrl: tpl,
			scope: $scope
		});
	}
 
	c.closeModal = function() {
		c.modalInstance.close();
	}*/
	
	$scope.showCommentBox = false;
	$scope.showComments = function(val) {
		console.log("comments",val);
		//if yes, show the add comments and previous comments
		if (val) {
			$scope.showCommentBox = true;
		} else {
			$scope.showCommentBox = false;
		}
	}
	
	console.log("Listening");
	$scope.$on("selectedSnippet",function(event,data) {
		$timeout(function() {
			console.log("BOOO",data);
			if (data) {
				$scope.comments = {};
				$scope.comments.show = false;
				$scope.snippet = data;
				
				if ($scope.snippet.snippet) {
					editor.setValue($scope.snippet.snippet);
					editor.clearSelection();
				} else {
					editor.setValue("//Enter Your Code Here");
				}

				$scope.snippetType = {
					displayValue: $scope.snippet.type.display_value,
					value: $scope.snippet.type.sys_id,
					name: 'snippetType'
				};
				$scope.snippetApp = {
					displayValue: $scope.snippet.application.display_value,
					value: $scope.snippet.application.sys_id,
					name: 'snippetApp'
				};
			}
		},500)
	})
	
	
	
	$scope.$on("field.change", function(evt, parms) {
		/*if (parms.field.name == 'snippetType') {
			c.data.setSnippetType = parms.newValue;
		}*/
		
		
		/*c.server.update().then(function(response) {
			spUtil.update($scope);
		});*/
	});
	
	$scope.loadTags = function(query) {
		
		return c.data.tagList;
	}
	
	
	
	$scope.submit = function(type) {
		console.log("Snippet",$scope.snippet);
		console.log("SnippetType",$scope.snippetType);
		console.log("SnippetApp",$scope.snippetApp);
		
		$scope.snippet.application = $scope.snippetApp;
		$scope.snippet.type = $scope.snippetType;
		$scope.snippet.editor = editor.getValue();
		
		c.data.snippet = $scope.snippet;
		
		console.log("C DATA",c.data.snippet);
		c.server.update().then(function(response) {
			//spUtil.update($scope);
			console.log("Response",response);
			$scope.snippet.application.display_value = $scope.snippet.application.displayValue;
			$scope.snippet.type.display_value = $scope.snippet.type.displayValue;
			
			if (response.recordAction && type == 'update') {
				console.log("UPDATE Scope",$scope.snippet);
				
				$scope.openModal('updatedSnippet');
				$timeout(function() {
					$rootScope.$broadcast("newTags",response.tagList);
					$scope.closeModal();
					window.location.reload();
					//spUtil.update($scope);
				},1000)
			}
			if (response.recordAction && type == 'insert') {
				$timeout(function() {
					
					//$rootScope.$broadcast('newSnippet',$scope.snippet);
					//spUtil.update($scope);
					$scope.closeModal();
					window.location.reload();
					
				});
			}
			
		})
		
		
	};
	

	String.prototype.escapeSpecialChars = function() {
    return this.replace(/(?:\r\n|\r|\n)/g, "<br>")
               /*.replace(/\\'/g, "\\'")
               .replace(/\\"/g, '\\"')
               .replace(/\&/g, "\\&")
               .replace(/\r/g, "\\r")
               .replace(/\t/g, "\\t")
               .replace(/\b/g, "\\b")
               .replace(/\f/g, "\\f");*/
	};
	console.log("Form",$scope);
}]]></client_script>
        <controller_as>c</controller_as>
        <css>#editor {
  height: 100%
}
.editor-group {
  /*height: 400px;*/
  margin-bottom: 40px;
}
.editor-new {
  /*height: 250px;*/
}
.editor-existing {
  /*height: 350px;*/
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>snippetnow-form</id>
        <internal>false</internal>
        <link/>
        <name>SnippetNow Form</name>
        <option_schema>[{"name":"type","label":"Type","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	
	if (input && input.snippet) {
		//console.log(input.snippet.simpleTags);
		var done = actionSnippet(input.snippet);
		if (done) {
			data.recordAction = true;
		} else {
			data.recordAction = false;
		}
	}
	
	/*data.snippetType = {};
	data.snippetType.name = 'Please Select';
	data.snippetType.value = '';
	data.snippetApp = {};
	data.snippetApp.name = 'Please Select';
	data.snippetApp.value = '';*/
	
	
	var record = {};
	record.sys_id = $sp.getParameter('sys_id');
	if (record.sys_id) {
		data.snippet = getSnippetRecord(record.sys_id);	
	} else {
		
		/*data.snippet = {};
		data.snippet.application = {};
		data.snippet.application.display_value = '';
		data.snippet.application.value = '';
		data.snippet.type = {};
		data.snippet.type.display_value = '';
		data.snippet.type.value = '';*/
	}
	
	data.tagList = new SnippetNow_DAO().getTagList();
	//$sp.log(data.snippet);
	
	function getSnippetRecord(sys_id) {
		/*******************
		* Get Snippet Record
		*
		*******************/
		var record = {};
		var rec = new GlideRecord('x_92893_snippetnow_table');
		rec.addEncodedQuery('sys_id='+sys_id);
		rec.query();
		while(rec.next()) {
			record.application = {};
			record.application.value = rec.application.toString();
			record.application.display_value = rec.getDisplayValue('application');
			record.type = {};
			record.type.value = rec.type.toString();
			record.type.display_value = rec.getDisplayValue('type');
			record.title = rec.getDisplayValue('title');
			record.description = rec.getDisplayValue('description');
			record.editor = rec.getValue('snippet');
			record.sys_id = rec.getUniqueValue();
			return record
			
		}
	}
	
	
	
	function actionSnippet(snippet) {
		/*******************
		* Create Snippet Record
		*
		*******************/
		var t = '';
		
		if (snippet.tags) {
			t = new SnippetNow_DAO().checkTags(snippet.tags);
			
		}
		console.log("Tags");
		console.log(t);
		
		var action;
		var rec = new GlideRecord('x_92893_snippetnow_table');
		rec.initialize();
		
		if (snippet && snippet.sys_id) {
			//tis update
			rec.addQuery('sys_id',snippet.sys_id);
			rec.query();
			while(rec.next()) {
				rec.title = snippet.title;
				rec.description = snippet.description;
				rec.snippet = snippet.editor;
				rec.type = snippet.type.value;
				rec.application = snippet.application.value;
				rec.tags = t;
				rec.comments = snippet.add_comments;
				action = rec.update();
				$sp.log(action);
				
			}
		} else {
			//tis insert
			rec.title = snippet.title;
			rec.description = snippet.description;
			rec.snippet = snippet.editor;
			rec.type = snippet.type.value;
			rec.application = snippet.application.value;
			rec.tags = t;
			action = rec.insert();
		}
		
		
		if (action) {
			return true
		}
		return false;
		
	}
	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2017-09-08 15:52:45</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>e974d74edb010300dfa77fcfbf9619a0</sys_id>
        <sys_mod_count>340</sys_mod_count>
        <sys_name>SnippetNow Form</sys_name>
        <sys_package display_value="SnippetNow" source="x_92893_snippetnow">86490346db010300dfa77fcfbf9619c2</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="SnippetNow">86490346db010300dfa77fcfbf9619c2</sys_scope>
        <sys_update_name>sp_widget_e974d74edb010300dfa77fcfbf9619a0</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2017-09-20 03:48:29</sys_updated_on>
        <template><![CDATA[<div>
<!-- your widget template -->
  <!--<div class="panel panel-primary">-->
    <!--<div class="panel-heading">New Snippet</div>-->
    <!--<div class="panel-body">-->
  	
      <h3>
        Snippet
      </h3>
    
      <form>
        <div class="form-group">
          <label for="snippetTitle">Title</label>
          <input type="text" ng-model="snippet.title" class="form-control" id="snippetTitle" placeholder="Snippet Title">
          <input type="hidden" ng-model="snippet.sys_id">
        </div>  
				<div class="form-group">
          <label for="snippetDescription">Description</label>
          <textarea class="form-control" ng-model="snippet.description"></textarea>
        </div>
        <!-- Need some types, and stuff here -->
        <div class="form-group">
          <label for="snippetApp">Snippet Application</label>
          <div >
            <sn-record-picker default-query="'active=true'" field="snippetApp" table="'x_92893_snippetnow_snippetnow_applications'" display-field="'name'" value-field="'sys_id'" search-fields="'name'" page-size="100" ></sn-record-picker>
          </div>
        </div>
        <div class="form-group">
          <label for="snippetType">Snippet Type</label>
          <div >
            <sn-record-picker default-query="'active=true'" field="snippetType" table="'x_92893_snippetnow_snippet_type'" display-field="'name'" value-field="'sys_id'" search-fields="'name'" page-size="100" ></sn-record-picker>
          </div>
        </div>
       <div class="form-group">
         <tags-input ng-model="snippet.tags" add-on-paste="true">
          <auto-complete source="loadTags($query)"></auto-complete>
        </tags-input>
        </div>
       <div class="form-group editor-group" ng-class="editorHeight()">
         <label for="snippetHTML">Snippet </label>
         <div class="small pull-right" ng-if="snippet.sys_id">Show comments <input type="checkbox" ng-model="comments.show" ng-change="showComments(comments.show)" ng-true-value="true" ng-false-value="false"/></div>
          <div id="snippetHTML" id="editor" ng-model="snippet.editor" class="form-control"></div>
       </div>
        <div ng-if="showCommentBox" class="form-group">
        	<label for="snippetComments">Add Comment</label>
          <textarea ng-model="snippet.add_comments" class="form-control"></textarea>
          
          <div class="comment-area">
            <label form="snippetPreviousComments">Previous Comments</label>
            <div>
              <div ng-repeat="comment in snippet.previous_comments">
                {{comment}}
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="pull-right">
            <button ng-if="!snippet.sys_id" class="btn btn-danger" ng-click="closeModal()">Cancel</button>
            <button ng-if="!snippet.sys_id" type="submit" class="btn btn-primary" ng-click="submit('insert')">Submit</button>
            <button ng-if="snippet.sys_id" type="submit" class="btn btn-success" ng-click="submit('update')">Update</button>
          </div>
  		</div>
      </form>
      
    <!--</div>-->
  <!--</div>-->
</div>
<script type="text/ng-template" id="updatedSnippet">
	<div ng-show="c.data.recordAction" class="alert alert-success" style="margin-bottom:0px">
    <strong>Success!</strong> Snippet has been updated!.
  </div>
  <div ng-show="c.data.recordAction == false" class="alert alert-danger" style="margin-bottom:0px">
    <strong>Error!</strong> Snippet did not save, please try again.
  </div>
</script>]]></template>
    </sp_widget>
</record_update>
